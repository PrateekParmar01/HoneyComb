<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static',filename='favicon.ico') }}">
    <script src="https://kit.fontawesome.com/9ec67280ec.js" crossorigin="anonymous"></script>
    <link href='https://css.gg/dribbble.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <!-- Bootstrap Font Icon CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <style>

      @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css");

      *{
          list-style: none;
          text-decoration: none;
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: 'Source Code Pro', cursive;
      }

      #message-form{

        background-color:rgb(85, 85, 85);

      }

      #message-input{
        background-color: gray;
        width: 50vwpx;
        height: 20px;
        margin-left: 300px;
      }

      #image{
          /* display: none; */

      }

  label[for="file-input"] {
    padding: 1em 1.5em;
    flex: 1 1 auto;
    text-align: center;
    color: #FFF;
    background-color: #1894AC;
    box-shadow: 1px 0 10px rgba(0,0,0,.15);
    border-radius: 5px;
    cursor: pointer;
  }

      /* .sent {
    text-align: right;
    background-color: #ff6a76;
    margin-left: 50%;
}

.sent span {
    margin-left: 5px;
    color: #6929ca;
} */

.image i.remove{
  vertical-align:middle;
  margin-left: 5px;
  cursor:pointer;
  display:none;
}
.image{
  display: none;
}

.messages {
	  display: flex;
	  flex-direction: column;
	  overflow: scroll;
	  height: 90%;
	  width: 100%;
	  background-color: white;
	  padding: 15px;
	  margin: 15px;
	  border-radius: 10px;
  }

      /* #message-form{
    text-align: center;
    position: fixed;
    left: 0;
    bottom: 0;
    width: 100%;
    background-color: rgb(69 114 186);;
} */

#message-form button{
    height: 100%;
    /* width: 100%; */
    /* border: 1px solid #444;
    outline: none;
    background: #222; */
    color: rgb(85, 85, 85);
    font-size: 17px;
    font-weight: 500;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  #message-form button:hover{
    background: #3a3a3a;
    color: rgb(202, 202, 202);
  }


      .news{
        width: 50vw;
        /* height: 500px; */
        margin: 10px;
        padding: 10px;
        margin-left: 200px;
        /* background-color: aquamarine; */
        border-radius: 10px;
      }
      .news img{
        height: 500px;
        border: 5px solid black;
        box-shadow: 5px 10px 30px gray;
      }

      .profile p{
          font-family: 'Lobster', cursive;
      }

      body{
          background: #f5f6fa;
      }

      .wrapper .sidebar{
          /* background-color: #0093E9; */
          background-image: linear-gradient(160deg, #261C2C 0%, #5C527F 100%);
          position: fixed;
          top: 0;
          left: 0;
          width: 225px;
          height: 100%;
          padding: 20px 0;
          transition: all 0.5s ease;
      }
      .wrapper .sidebar .profile{
          margin-bottom: 30px;
          text-align: center;
      }

      .wrapper .sidebar .profile img{
          display: block;
          width: 100px;
          height: 100px;
          border-radius: 50%;
          margin: 0 auto;
      }
      .wrapper .sidebar .profile h3{

          color: #ffffff;
          margin: 10px 0 5px;
      }

      .wrapper .sidebar .profile p{
          color: rgb(206, 240, 253);
          font-size: 14px;
      }
      .wrapper .sidebar ul li a{
          display: block;
          padding: 13px 30px;
          border-bottom: 0.5px solid aliceblue;
          color: rgb(241, 237, 237);
          font-size: 13.4px;
          position: relative;
      }

      .wrapper .sidebar ul li a .icon{
          color: #dee4ec;
          width: 30px;
          display: inline-block;
      }
      .wrapper .sidebar ul li a:hover,
      .wrapper .sidebar ul li a.active{
          color: black;
          font-weight: bold;

          background: #726A95;
          border-right: 2px solid #94aabd;
      }

      .wrapper .sidebar ul li a:hover .icon,
      .wrapper .sidebar ul li a.active .icon{
          color: #222831;
      }

      .container{
          position: absolute;
          bottom: 0;
          right: 0;
          /* background-color: black; */
          width: 83.5vw;
          height: 92.5vh;
      }

      .wrapper .sidebar ul li a:hover:before,
      .wrapper .sidebar ul li a.active:before{
          display: block;
      }
      .wrapper .section{
          width: calc(100% - 225px);
          margin-left: 225px;
          transition: all 0.5s ease;
      }

      .wrapper .section .top_navbar{
          background: #3E2C41;
          height: 50px;
          display: flex;
          align-items: center;
          padding: 0 30px;

      }

      .wrapper .section .top_navbar .hamburger a{
          font-size: 20px;
          color: #f4fbff;
      }

      .wrapper .section .top_navbar .hamburger a:hover{
          color: #C996CC      ;
      }
      body.active .wrapper .sidebar{
          left: -225px;
      }

      body.active .wrapper .section{
          margin-left: 0;
          width: 100%;
      }
      .prof-name
      {
          font-weight: 500;
      }

      .sidebar{
          width: 50px;
      }

      #top{
          font-weight: 700;
          color:white;
          margin-left: 300px;
      }

    </style>
    <script src="https://cdn.firebase.com/js/client/2.2.1/firebase.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
    />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <link rel="stylesheet" href="./index.css" /> -->

    <title>Document</title>
    <script type="text/javascript">
      function noenter() {
        return !(window.event && window.event.keyCode == 13); }
    </script>
  </head>

  <body>
    <div class="wrapper">
      <!--Top menu -->
      <div class="section">
        <div class="top_navbar">
          <div class="hamburger">
            <a href="#">
              <i class="fas fa-bars"></i>
            </a>
          </div>
          <h3 id="top">Be Sweet Like Honey</h3>
        </div>
      </div>
      <div class="sidebar">
        <!--profile image & text-->
        <div class="profile">
          <img src="{{ url_for('static',filename='HoneyComb.jpg') }}" alt="profilepic" />
          <h3 class="prof-name">{{ uname }}</h3>
        </div>
        <!--menu item-->
        <ul class="sidee">
          <li>
            <a href="#" class="active">
              <span class="icon"><i class="fa-solid fa-desktop"></i></span>
              <span class="item">NewsFeed</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><i class="fa-solid fa-people-arrows-left-right"></i></span>
              <span class="item">Alumini</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart-line-fill" viewBox="0 0 16 16">
                <path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1V2z"/>
              </svg></span>

              <span class="item">CP Wing</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><i class="fa-solid fa-code"></i></span>
              <span class="item">SoftDev wing</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><i class="fa-brands fa-linux"></i></span>
              <span class="item">InfoSec Wing</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><i class="fas fa-cog"></i></span>
              <span class="item">ML Wing</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><i class="bi bi-person-bounding-box"></i></span>
              <span class="item">UI/UX Wing</span>
            </a>
          </li>
          <li>
            <a href="#" id="crotonia-bar">
              <span class="icon"><i class="fas fa-pen-fancy"></i></span>
              <span class="item">Crotonia</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><i class="fa-solid fa-masks-theater"></i></span>
              <span class="item">Goonj</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><i class="fa-solid fa-camera"></i></span>
              <span class="item">After Dark</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><i class="fa-solid fa-z"></i></span>
              <span class="item">Zypher</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><i class="fas fa-guitar"></i></i></span>
              <span class="item">Estrella</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><i class="gg-dribbble"></i></span>
              <span class="item">Eifer</span>
            </a>
          </li>
          <li>
            <a href="#">
              <span class="icon"><i class="fa-solid fa-people-arrows-left-right"></i></span>
              <span class="item">Students</span>
            </a>
          </li>
          <li>

        </ul>

      </div>
    </div>

    <div id="containner" class="container">
      <div id="chat">
        <ul id="messages"></ul>
        <form id="message-form" onkeypress="noenter()">
          <input id="message-input" type="text" />
          <button id="message-btn" type="submit">Send</button>
          <button>
        </form>
        <span>
        <input id="image" type="file">
        <label for="image">
          <i class="fa fa-paperclip fa-2x"></i>
          <span></span>
        </label>
        <!-- <i class="fa fa-times-circle remove"></i> -->
        <button id="image-btn" type="submit">Send2</button></span>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js";
// import { getStorage } from 'https://www.gstatic.com/firebasejs/5.9.1/firebase-storage.js';
import { getStorage } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAeaHc0agHVEGNC24xd8CnZWxD-IibrE7U",
  authDomain: "honeycomb2.firebaseapp.com",
  databaseURL: "https://honeycomb2-default-rtdb.firebaseio.com",
  projectId: "honeycomb2",
  storageBucket: "honeycomb2.appspot.com",
  messagingSenderId: "129839087943",
  appId: "1:129839087943:web:7f70c218de4682ed148c62",
};

// Initialize Firebase
//   const app = initializeApp(firebaseConfig);
firebase.initializeApp(firebaseConfig);
// firebase.initializeApp(firebaseConfig).getStorage();

const username = document.getElementsByClassName("prof-name")[0].innerText;


document.getElementById("crotonia-bar").addEventListener("click", function (e){
  document.getElementsByClassName("active")[0].classList.remove("active");
  document.getElementById("crotonia-bar").classList.add("active");
  console.log(document.getElementById("messages").innerText);
  document.getElementById("messages").innerText = "";

  document.getElementById("message-form").addEventListener("submit", sendMessage);

  function sendMessage(e) {
    e.preventDefault();

    // get values to be submitted
    const timestamp = Date.now();
    const messageInput = document.getElementById("message-input");
    const message = messageInput.value;

    // clear the input box
    messageInput.value = "";

    //auto scroll to bottom
    // document
    //   .getElementById("messages")
    //   .scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });

    // create db collection and send in the data
    firebase.database().ref("crotonia/" + timestamp).set({
      username,
      message,
    });
  }

  const fetchChat = firebase.database().ref("crotonia/");

  fetchChat.on("child_added", function (snapshot) {
    const messages = snapshot.val();
    const message = `<li class=${
      username === messages.username ? "sent" : "receive"
    }><span>${messages.username}: </span>${messages.message}</li>`;
    // append the message on the page
    document.getElementById("messages").innerHTML += message;
  });


})


if(document.getElementsByClassName("active")[0].innerText==" NewsFeed"){
  // console.log(document.getElementsByClassName("active")[0].innerText);
  // if(document.getElementsByClassName("active")[0].innerText===" NewsFeed") console.log(1);
document
  .getElementById("message-form")
  .addEventListener("submit", function (e) {
    e.preventDefault();

    console.log(document.querySelector("#image").files.length);

    if(document.querySelector("#image").files.length==0){

    const timestamp = Date.now();
    const messageInput = document.getElementById("message-input");
    const message = messageInput.value;

    // using sightengine for moderation
    //start

    console.log(message);
    const d = new FormData();
    d.append('text', message);
    d.append('lang', 'en');
    d.append('opt_countries', 'us,gb,fr');
    d.append('mode', 'standard');
    d.append('api_user', '45211228');
    d.append('api_secret', 'UwQPeDmdHyZBgpaKLUqF');
    const moderationJSON=fetch('https://api.sightengine.com/1.0/text/check.json',{
        method:'POST',
        body: d
    }).then(function (response) {
        // on success: handle response
        console.log("success")

        return response.json();
        }).then(
            function(moderationJSON) {
                //console.log(data)
                console.log(moderationJSON)
                let shouldSend = true;
                console.log(moderationJSON.personal)
                if(moderationJSON.personal.matches.length>0){
                  shouldSend = false;
                }
                console.log(moderationJSON.profanity)
                if(moderationJSON.profanity.matches.length>0){
                  shouldSend = false;
                }
                  // end
                messageInput.value = "";

                document
                  .getElementById("messages")
                  .scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });

                window.scrollBy(0, 100);
                var flag = 0;
                // pageScroll();
                // create db collection and send in the data
                if(shouldSend==true){
                  firebase
                  .database()
                  .ref("messages/" + timestamp)
                  .set({
                    username,
                    message,
                    flag,
                  });
                }
            }
        )
        .catch(function (error) {
        // handle error
        console.log("error")
        if (error.response) console.log(error.response.data);
        else console.log(error.message);
        });
        // end
    }


  });

// document.getElementById("message-form").addEventListener("keypress", )
const ref = firebase.storage().ref();
document.getElementById("image-btn").addEventListener("click", function (e) {
  e.preventDefault();
  const file = document.querySelector("#image").files[0];
  const name = +new Date() + "-" + file.name;
  const metadata = { contentType: file.type };
  const task = ref.child(name).put(file, metadata);
  // task
  //   .then((snapshot) => snapshot.ref.getDownloadURL())
  //   .then((url) => console.log(url));
  const timestamp = Date.now();
  task
    .then((snapshot) => snapshot.ref.getDownloadURL())
    .then((url) => {
      var flag = 1;
      firebase
        .database()
        .ref("messages/" + timestamp)
        .set({
          username,
          url,
          flag,
        });
    });
});

// function pageScroll() {
//   window.scrollBy(0,1);
//   scrolldelay = setTimeout(pageScroll,10);
// }

firebase
  .database()
  .ref("messages/")
  .on("child_added", function (snapshot) {
    const snap = snapshot.val();
    if (snap.flag == 0) {
      const message = `<li class="news"><span><i>${
        username == snap.username ? "You" : snap.username
      }: </i></span>${snap.message}</li>`;
      document.getElementById("messages").innerHTML += message;
    } else {
      const message = `<li class="news"><span><i>${
        username == snap.username ? "You" : snap.username
      }: </i></span><img src="${snap.url}"></img></li>`;
      document.getElementById("messages").innerHTML += message;
    }
  });
}

// firebase
//   .database()
//   .ref("images/")
//   .on("child_added", function (snapshot) {
//     const messages = snapshot.val();
//     const message = `<li class="news"><span><i>${
//       username == messages.username ? "You" : messages.username
//     }: </i></span><img src="${messages.url}"></img></li>`;
//     document.getElementById("messages").innerHTML += message;
//   });

    </script>
  </body>
</html>
